<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My Grist Chart Widget</title>
    <!-- Include Plotly.js library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  </head>

  <body>
    <!-- Create a container element for the chart -->
    <div id="myDiv2" style="height: 1200px"></div>

    <script>
      // Wait for the Grist API to be ready
      grist.ready({
        columns: ["Perf", "KPI", "Target", "Color"],
        requiredAccess: "read table",
      });

      // When a new record is selected in the Grist table, render a chart based on its data
      grist.onRecords(function (records, mappings) {
        let mapped = grist.mapColumnNames(records);
        // document.getElementById("mapped").innerHTML = JSON.stringify(
        //   mapped,
        //   null, /
        //   2
        // );
        if (mapped) {
          // mJson = mapped Json from mapped column
          let mPerfs = mapped.map(({ KPI, Perf, Target, Color }) => ({
            KPI,
            Perf,
            Target,
            Color,
          }));

          // let data = [];

          let i = 1;
          for (let mPerf of mPerfs) {}
            var data = [
              {
                type: "indicator",
                mode: "number+gauge+delta",
                value: 220,

                delta: { reference: 280, position: "top" },
                title: {
                  text: "<b>Profit</b><br><span style='color: gray; font-size:0.8em'>U.S. $</span>",
                  font: { size: 14 },
                },
                gauge: {
                  shape: "bullet",
                  axis: { range: [null, 300] },
                  threshold: {
                    line: {
                      color: "red",
                      width: 2,
                      gradient: { yanchor: "vertical" },
                    },
                    thickness: 0.75,
                    value: 270,
                  },
                  bgcolor: "white",
                  steps: [{ range: [0, 150], color: "cyan" }],
                  bar: { color: "darkblue" },
                },
              },
            ];
            // data.push(trace);

          console.log(data);

          var layout = {
            grid: { rows: 9, columns: 1, pattern: "independent" },
            width:800,
            heigh:800,
          };

          const config = {
            displayModeBar: false, // this is the line that hides the bar.
            responsive: true,
          };

          Plotly.newPlot("myDiv2", data, layout, config);
        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }
      });
    </script>
  </body>
</html>
