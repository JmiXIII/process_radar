<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My Grist Chart Widget</title>
    <!-- Include Plotly.js library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  </head>

  <body>
    <!-- Create a container element for the chart -->
    <div id="myDiv2" style="position: relative; height: 500px;"></div>

    <script>
      // Wait for the Grist API to be ready
      grist.ready({
        columns: ["Perf", "KPI", "Target", "Color"],
        requiredAccess: "read table",
      });

      // const plotDiv = document.getElementById("myDiv");

      // Set the height and width of the Plotly chart to match the iframe
      // const layout = {
      //   title: {
      //     // automargin: true,
      //   },
      //   legend: {
      //     xanchor: "right",
      //     yanchor: "top",
      //     bgcolor: "rgba(0,0,0,0.15)",
      //     font: {
      //       size: 10,
      //     },
      //   },
      //   // autosize: true,
      //   yaxis: {
      //     tickmode: "auto",
      //   },
      //   // margin: {
      //   //   l: 30,
      //   //   r: 5,
      //   //   t: 5,
      //   //   pad: 0,
      //   // },
      // };

      const config = {
        displayModeBar: false, // this is the line that hides the bar.
        responsive: true,
      };

      // When a new record is selected in the Grist table, render a chart based on its data
      grist.onRecords(function (records, mappings) {
        let mapped = grist.mapColumnNames(records);
        // document.getElementById("mapped").innerHTML = JSON.stringify(
        //   mapped,
        //   null, /
        //   2
        // );
        if (mapped) {
          // mJson = mapped Json from mapped column
          let mPerfs = mapped.map(({ KPI, Perf, Target, Color }) => ({
            KPI,
            Perf,
            Target,
            Color,
          }));

          let data = [];

          let i = 1;
          for (let mPerf of mPerfs) {
            let perfTrace = {
              x: [mPerf.Perf],
              y: [mPerf.KPI],
              xaxis: "x" + i,
              yaxis: "y" + i,
              type: "bar",
              orientation: "h",
              width: 0.5,
              marker: {
                color: mPerf.Color,
              },
            };
            let targetTrace = {
              x: [mPerf.Target],
              y: [mPerf.KPI],
              xaxis: "x" + i,
              yaxis: "y" + i,
              type: "bar",
              orientation: "h",
              marker: {
                color: "rgba(184,184,184,0.6)",
              },
            };
            data.push(targetTrace, perfTrace);
            i++;
          }

          console.log(data);

          var layout = {
            grid: { rows: 9, columns: 1, pattern: "independent" },
            barmode: "overlay",
            legend: {
              bgcolor: "rgba(0,0,0,0.15)",
              font: {
                size: 10,
              },
              margin: {
                l: 30,
                r: 5,
                t: 5,
                pad: 0,
              },
            },
          };

          Plotly.newPlot("myDiv2", data, layout);
        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }
      });
    </script>
  </body>
</html>
