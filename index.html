<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>My Grist Chart Widget</title>
    <!-- Include Plotly.js library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  </head>

  <body>
    <!-- Create a container element for the chart -->
    <div id="myDiv"></div>

    <script>
      // Wait for the Grist API to be ready
      grist.ready({
        columns: ["Perf", "KPI", "Target", "Color"],
        requiredAccess: "read table",
      });

      // When a new record is selected in the Grist table, render a chart based on its data
      grist.onRecords(function (records, mappings) {
        let mapped = grist.mapColumnNames(records);
        // document.getElementById("mapped").innerHTML = JSON.stringify(
        //   mapped,
        //   null, /
        //   2
        // );
        if (mapped) {
          // mJson = mapped Json from mapped column
          let mPerfs = mapped.map(({ KPI, Perf, Target, Color }) => ({
            KPI,
            Perf,
            Target,
            Color,
          }));

          // let data = [
          //   {
          //     domain: { row: 0, column: 0 },
          //     value: 450,
          //     title: { text: "ONE LONG TITLE" },
          //     type: "indicator",
          //     mode: "gauge+number",
          //     gauge: { shape: "bullet", axis: { range: [null, 500] } },
          //   },
          //   {
          //     domain: { row: 0, column: 1 },
          //     value: 450,
          //     title: { text: "TWO" },
          //     type: "indicator",
          //     mode: "gauge+number",
          //     gauge: {
          //       shape: "bullet",
          //       bar: { color: "red" },
          //       axis: { range: [null, 500] },
          //     },
          //   },
          //   {
          //     domain: { row: 1, column: 0 },
          //     value: 450,
          //     title: { text: "THREE" },
          //     type: "indicator",
          //     mode: "gauge+number",
          //     gauge: {
          //       shape: "bullet",
          //       bar: { color: "blue" },
          //       axis: { range: [null, 500] },
          //     },
          //   },
          //   {
          //     domain: { row: 1, column: 1 },
          //     value: 450,
          //     title: { text: "FOUR" },
          //     type: "indicator",
          //     mode: "gauge+number",
          //     gauge: {
          //       shape: "bullet",
          //       bar: { color: "purple" },
          //       axis: { range: [null, 500] },
          //     },
          //   },
          // ];

          let data = [];
          var layout = {
            grid: {
              rows: 10,
              columns: 1,
              pattern: "coupled",
              xgap: 0.5,
              ygap: 0.5,
            },
          };
          let i = 1;
          for (let mPerf of mPerfs) {
            let trace = {
              domain: { row: i, column: 0 },
              value: 450,
              title: { text: " TITLE" },
              type: "indicator",
              mode: "gauge+number",
              gauge: { shape: "bullet", axis: { range: [null, 500] } },
            };
            data.push(trace);
            i++;
          }

          console.log("############## ->",data);

          // var layout = {
          //   grid: {
          //     rows: 9,
          //     columns: 1,
          //     pattern: "coupled",
          //     xgap: 0.5,
          //     ygap: 0.5,
          //   },
          // };

          Plotly.newPlot("myDiv", data, layout);
        } else {
          // Helper returned a null value. It means that not all
          // required columns were mapped.
          console.error("Please map all columns");
        }
      });
    </script>
  </body>
</html>
